#include <stdio.h>
#include <string.h>

__sfr __at 0xfe ZX_Control;

__sfr __at 0x57 Next_SpriteAttribute;
__sfr __at 0x5b Next_SpritePattern;

__sfr __banked __at 0x243b Next_RegisterNumber;
__sfr __banked __at 0x253b Next_RegisterValue;

__sfr __banked __at 0x123b Next_Layer2AccessPort;

__sfr __banked __at 0x303b Next_SpriteControl;

#define NEXT_SPRITELAYERMODE    0x15
#define NEXT_LAYER2_XOFFSET     0x16
#define NEXT_LAYER2_YOFFSET     0x17
#define NEXT_SPRITENUMBER       0x34
#define NEXT_SPRITEX            0x35
#define NEXT_SPRITEY            0x36
#define NEXT_SPRITEATTR2        0x37

#define NEXT_PALETTEINDEX       0x40
#define NEXT_PALETTEVALUE8      0x41
#define NEXT_PALETTECONTROL     0x43

#define NEXT_TILEMAPCONTROL     0x6b
#define NEXT_TILEBASE           0x6e
#define NEXT_TILEDEFINITIONS    0x6f

#define NEXT_GETREG(reg) \
    (Next_RegisterNumber = (reg), Next_RegisterValue)

#define NEXT_SETREG(reg, value) \
    (Next_RegisterNumber = (reg), Next_RegisterValue = (value))

static const unsigned char TileData[] = {
        0x44, 0x44, 0x44, 0x43,
        0x4F, 0xFF, 0xFF, 0x43,
        0x4F, 0xBB, 0xBF, 0x43,
        0x4F, 0xB5, 0x5B, 0xF4,
        0x4F, 0xB5, 0x88, 0xBF,
        0x4F, 0xFB, 0x84, 0x8B,
        0x44, 0x4F, 0xB8, 0x48,
        0x33, 0x34, 0xFB, 0x84,
        0x33, 0x33, 0x4F, 0xB4,
        0x33, 0x33, 0x34, 0xFB,
        0x33, 0x33, 0x33, 0x4F,
        0x33, 0x33, 0x33, 0x34,
        0x33, 0x33, 0x33, 0x33,
        0x33, 0x33, 0x33, 0x34,
        0x33, 0x33, 0x33, 0x33,
        0x33, 0x33, 0x33, 0x33,

        0x33, 0x33, 0x33, 0x33,
        0x33, 0x33, 0x33, 0x33,
        0x33, 0x33, 0x33, 0x33,
        0x33, 0x33, 0x33, 0x33,
        0x43, 0x33, 0x33, 0x33,
        0xF4, 0x33, 0x33, 0x33,
        0xBF, 0x43, 0x33, 0x33,
        0x4B, 0xF4, 0x34, 0x33,
        0x44, 0xBF, 0x4D, 0x43,
        0x44, 0x44, 0xAD, 0x43,
        0xB4, 0xF5, 0x44, 0x33,
        0xF4, 0x58, 0x43, 0x33,
        0x4A, 0x44, 0x84, 0x33,
        0xDD, 0x43, 0x45, 0x43,
        0x44, 0x33, 0x34, 0xA4,
        0x33, 0x33, 0x33, 0x44,
    };

static const unsigned char SpriteData[] = {
        0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3,
        0x04, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x04, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3,
        0x04, 0xFF, 0xFB, 0xFB, 0xFB, 0xFF, 0x04, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3,
        0x04, 0xFF, 0xFB, 0xF5, 0xF5, 0xFB, 0xFF, 0x04, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3,
        0x04, 0xFF, 0xFB, 0xF5, 0xA8, 0xA8, 0xFB, 0xFF, 0x04, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3,
        0x04, 0xFF, 0xFF, 0xFB, 0xA8, 0x44, 0xA8, 0xFB, 0xFF, 0x04, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3,
        0x04, 0x04, 0x04, 0xFF, 0xFB, 0xA8, 0x44, 0xA8, 0xFB, 0xFF, 0x04, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3,
        0xE3, 0xE3, 0xE3, 0x04, 0xFF, 0xFB, 0xA8, 0x44, 0x44, 0xFB, 0xFF, 0x04, 0xE3, 0x04, 0xE3, 0xE3,
        0xE3, 0xE3, 0xE3, 0xE3, 0x04, 0xFF, 0xFB, 0x44, 0x44, 0x44, 0xFB, 0xFF, 0x04, 0x4D, 0x04, 0xE3,
        0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0x04, 0xFF, 0xFB, 0x44, 0x44, 0x44, 0x44, 0xFA, 0x4D, 0x04, 0xE3,
        0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0x04, 0xFF, 0xFB, 0x44, 0xFF, 0xF5, 0x44, 0x04, 0xE3, 0xE3,
        0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0x04, 0xFF, 0x44, 0xF5, 0xA8, 0x04, 0xE3, 0xE3, 0xE3,
        0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0x04, 0xFA, 0x44, 0x04, 0xA8, 0x04, 0xE3, 0xE3,
        0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0x04, 0x4D, 0x4D, 0x04, 0xE3, 0x04, 0xF5, 0x04, 0xE3,
        0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0x04, 0x04, 0xE3, 0xE3, 0xE3, 0x04, 0xFA, 0x04,
        0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0xE3, 0x04, 0x04,
    };

int main()
{
    // Enabling layer 2

    Next_Layer2AccessPort = 3; // 00000011

    // Loading layer2 palette

    /*
    NEXT_SETREG(NEXT_PALETTECONTROL, 0x10); // 00010000
    NEXT_SETREG(NEXT_PALETTEINDEX, 0);
    for (int i = 0; i < 256; i++)
        NEXT_SETREG(NEXT_PALETTEVALUE8, (unsigned char)i);
    */

    // Drawing to layer2

    __asm
    di
    __endasm;

    unsigned i = 0;
    for (int bank = 0; bank < 3; bank++) {
        Next_Layer2AccessPort = (bank << 6) | 3; // xx000011
        unsigned char* p = (unsigned char*)0;
        unsigned char* end = (unsigned char*)0x4000;
        for (; p < end; p++, i++)
            *p = (i & 0xff);
    }

    // Sprites

    Next_SpriteControl = 0;

    for (i = 0; i < sizeof(SpriteData); i++)
       Next_SpritePattern = SpriteData[i];

    Next_SpriteAttribute = 100;
    Next_SpriteAttribute = 100;
    Next_SpriteAttribute = 0;
    Next_SpriteAttribute = 0x80; // enable sprite

    NEXT_SETREG(NEXT_SPRITELAYERMODE,
        NEXT_GETREG(NEXT_SPRITELAYERMODE) | 0x01);

    // Tiles

    memcpy((void*)0x4c00, TileData, sizeof(TileData));
    NEXT_SETREG(NEXT_TILEDEFINITIONS, 0x0C);

    unsigned char* pTile = (unsigned char*)0x6C00;
    for (int y = 0; y < 32; y++) {
        for (int x = 0; x < 40; x++) {
            // ((x&1)<<1)+(y&1)
            if ((y & 1) == 0)
                *pTile = ((x & 1) == 1 ? 0 : 2);
            else
                *pTile = ((x & 1) == 1 ? 1 : 3);
            ++pTile;
        }
    }
    NEXT_SETREG(NEXT_TILEBASE, 0x2C);

    NEXT_SETREG(NEXT_TILEMAPCONTROL, 0xa3); // 10100011

    // -----

    /*
    Next_Layer2AccessPort = 0;

    __asm
    ei
    __endasm;
    */

    int offset = 0, x = 100, y = 100, dx = 1, dy = 1;
    for (;;) {
        //int i = offset;

        //ZX_Control = (offset & 7);
        NEXT_SETREG(NEXT_LAYER2_XOFFSET, (offset & 0xff));

        NEXT_SETREG(NEXT_SPRITENUMBER, 0);
        NEXT_SETREG(NEXT_SPRITEX, (x & 0xff));
        NEXT_SETREG(NEXT_SPRITEY, (y & 0xff));
        NEXT_SETREG(NEXT_SPRITEATTR2, ((x >> 8) & 1));

        for (i = 0; i < 8192; i++) {}
        /*
        __asm
        halt
        __endasm;
        */

        x += dx;
        y += dy;
        if (x == 31) dx = 1;
        if (x == 319) dx = -1;
        if (y == 31) dy = 1;
        if (y == 255) dy = -1;

        offset++;
    }
}
